<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperCharge - Daily Creativity Challenge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24);
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .nav-links {
            text-align: center;
            margin-bottom: 20px;
        }

        .nav-links a {
            color: #667eea;
            text-decoration: none;
            margin: 0 15px;
            padding: 8px 16px;
            border: 1px solid #667eea;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background-color: #667eea;
            color: white;
        }

        .game-mode-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .game-mode-info.room {
            background: #f3e5f5;
            border-left-color: #9c27b0;
        }
        
        .phase {
            display: none;
        }
        
        .phase.active {
            display: block;
        }
        
        .superpower-card {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 15px 30px rgba(238, 90, 36, 0.3);
        }
        
        .superpower-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .superpower-description {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .instructions {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }
        
        .instructions h3 {
            color: #495057;
            font-size: 1.3rem;
            margin-bottom: 15px;
        }
        
        .instructions ul {
            color: #6c757d;
            font-size: 1rem;
            line-height: 1.6;
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .deadline-timer {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .idea-form {
            display: grid;
            gap: 25px;
        }
        
        .idea-input {
            position: relative;
        }
        
        .idea-input label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .idea-input textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 15px;
            font-size: 1rem;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        .idea-input textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .word-count {
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-size: 0.9rem;
            color: #6c757d;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 5px;
            pointer-events: none;
        }
        
        .word-count.warning {
            color: #e17055;
        }
        
        .word-count.error {
            color: #d63031;
            font-weight: bold;
        }
        
        .btn {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 16px rgba(0, 184, 148, 0.3);
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 184, 148, 0.4);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn.danger {
            background: linear-gradient(135deg, #e17055, #d63031);
            box-shadow: 0 8px 16px rgba(225, 112, 85, 0.3);
        }
        
        .btn.danger:hover {
            box-shadow: 0 12px 24px rgba(225, 112, 85, 0.4);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status-success {
            background: #d1edff;
            color: #0c63e4;
            border: 1px solid #b3d7ff;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .rating-timer {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .rating-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .leaderboard-preview {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        
        .leaderboard-preview h3 {
            color: #495057;
            margin-bottom: 15px;
        }
        
        .leaderboard-preview p {
            color: #6c757d;
            font-size: 1.1rem;
        }
        
        .user-id-input {
            background: #e9ecef;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .user-id-input label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
        }
        
        .user-id-input input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ SuperCharge</h1>
            <p id="headerSubtitle">Daily Creativity Challenge</p>
        </div>

        <div class="nav-links">
            <a href="cloth.html">üìÖ Daily Challenge</a>
            <a href="rooms.html">üéÆ Custom Rooms</a>
            <a href="admin.html">‚öôÔ∏è Admin</a>
        </div>

        <div id="gameModeInfo" class="game-mode-info" style="display: none;">
            <p id="gameModeText"></p>
        </div>
        
        <!-- Phase 1: Get User ID -->
        <div id="userIdPhase" class="phase active">
            <div class="user-id-input">
                <label for="userId">Enter your username to continue:</label>
                <input type="text" id="userId" placeholder="Choose a unique username" required>
                <br><br>
                <button class="btn" onclick="setUserId()">Continue</button>
            </div>
        </div>
        
        <!-- Phase 2: Daily Superpower & Submission -->
        <div id="submissionPhase" class="phase">
            <div id="superpowerCard" class="superpower-card">
                <div class="superpower-title" id="superpowerTitle">Loading today's challenge...</div>
                <div class="superpower-description" id="superpowerDescription"></div>
            </div>
            
            <div class="instructions">
                <h3>üéØ How to Play SuperCharge</h3>
                <ul>
                    <li><strong>Be Creative & Practical:</strong> Come up with unusual ideas that actually work in the real world</li>
                    <li><strong>Think Outside the Box:</strong> The best ideas are both innovative and implementable</li>
                    <li><strong>Four Ideas Required:</strong> Submit exactly 4 of your best ideas</li>
                    <li><strong>Word Limit:</strong> Each idea must be 100 words or less</li>
                    <li><strong>Daily Deadline:</strong> Submit before 11:59 PM today</li>
                </ul>
            </div>
            
            <div class="deadline-timer" id="deadlineTimer">
                ‚è∞ Time remaining: <span id="timeRemaining">Loading...</span>
            </div>
            
            <div id="statusMessage" class="hidden"></div>
            
            <form id="ideaForm" class="idea-form">
                <div class="idea-input">
                    <label for="idea1">üí° Idea #1</label>
                    <textarea id="idea1" name="idea1" placeholder="Describe your first creative application..." required></textarea>
                    <div class="word-count" id="count1">0/100 words</div>
                </div>
                
                <div class="idea-input">
                    <label for="idea2">üí° Idea #2</label>
                    <textarea id="idea2" name="idea2" placeholder="Describe your second creative application..." required></textarea>
                    <div class="word-count" id="count2">0/100 words</div>
                </div>
                
                <div class="idea-input">
                    <label for="idea3">üí° Idea #3</label>
                    <textarea id="idea3" name="idea3" placeholder="Describe your third creative application..." required></textarea>
                    <div class="word-count" id="count3">0/100 words</div>
                </div>
                
                <div class="idea-input">
                    <label for="idea4">üí° Idea #4</label>
                    <textarea id="idea4" name="idea4" placeholder="Describe your fourth creative application..." required></textarea>
                    <div class="word-count" id="count4">0/100 words</div>
                </div>
                
                <button type="submit" class="btn" id="submitIdeasBtn">
                    <span id="submitText">Submit My 4 Ideas</span>
                    <span id="submitLoader" class="loading hidden"></span>
                </button>
            </form>
        </div>
        
        <!-- Phase 3: Rating Period -->
        <div id="ratingPhase" class="phase">
            <div class="rating-timer" id="ratingTimer">
                ‚è±Ô∏è Rating Time: <span id="ratingTimeRemaining">15:00</span>
            </div>
            
            <div class="rating-instructions">
                <h3>üéØ Rate Other People's Ideas</h3>
                <p><strong>Your score depends on both your idea quality AND rating accuracy!</strong></p>
                <p>Rate how similar these ideas are to each other on a scale of 1-5. Your ratings will be compared to other participants' ratings.</p>
            </div>
            
            <div id="ratingContent">
                <p>Loading rating pairs...</p>
            </div>
        </div>
        
        <!-- Phase 4: Results -->
        <div id="resultsPhase" class="phase">
            <div class="leaderboard-preview">
                <h3>üéâ Great Job!</h3>
                <p id="resultsMessage">You scored in the top 20%!</p>
                <p style="margin-top: 20px; font-size: 1.2rem; font-weight: bold;">Check back tomorrow at 12 AM for full results and leaderboard!</p>
                
                <button class="btn" onclick="location.reload()" style="margin-top: 20px; width: auto; padding: 15px 30px;">
                    üîÑ Try Tomorrow's Challenge
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://gsx73a1w3d.execute-api.us-east-1.amazonaws.com/prod';
        let currentUser = '';
        let currentSuperpower = null;
        let ratingTimer = null;
        let deadlineTimer = null;
        let gameMode = 'global'; // 'global' or 'room'
        let currentRoomId = null;
        let currentRoom = null;
        
        // Initialize the application
        async function init() {
            // Check URL parameters for room mode
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const roomId = urlParams.get('roomId') || localStorage.getItem('supercharge_roomId');
            
            if (mode === 'room' && roomId) {
                gameMode = 'room';
                currentRoomId = roomId;
                await setupRoomMode();
            } else {
                gameMode = 'global';
                setupGlobalMode();
            }
            
            // Set up word counters
            setupWordCounters();
            
            // Set up deadline timer
            setupDeadlineTimer();
            
            // Check for saved user
            checkSavedUser();
        }

        function setupGlobalMode() {
            document.getElementById('headerSubtitle').textContent = 'Daily Creativity Challenge';
            document.getElementById('gameModeInfo').style.display = 'none';
        }

        async function setupRoomMode() {
            try {
                // Get user's rooms to find this room's details
                const savedUserId = localStorage.getItem('supercharge_userId');
                if (savedUserId) {
                    const response = await fetch(`${API_BASE_URL}/rooms/list?userId=${savedUserId}`);
                    const result = await response.json();
                    
                    if (response.ok) {
                        currentRoom = result.rooms.find(room => room.roomId === currentRoomId);
                        if (currentRoom) {
                            document.getElementById('headerSubtitle').textContent = 'Custom Room Challenge';
                            const infoEl = document.getElementById('gameModeInfo');
                            const textEl = document.getElementById('gameModeText');
                            textEl.innerHTML = `
                                üéÆ <strong>Room:</strong> ${currentRoom.roomName} 
                                | üîë <strong>Code:</strong> ${currentRoom.gameCode} 
                                | üë• <strong>Players:</strong> ${currentRoom.memberCount}/${currentRoom.maxPlayers}
                            `;
                            infoEl.className = 'game-mode-info room';
                            infoEl.style.display = 'block';
                        }
                    }
                }
            } catch (error) {
                console.error('Error setting up room mode:', error);
            }
        }
        
        // Set user ID and move to submission phase
        function setUserId() {
            const userIdInput = document.getElementById('userId');
            const userId = userIdInput.value.trim();
            
            if (!userId) {
                alert('Please enter a username');
                return;
            }
            
            currentUser = userId;
            localStorage.setItem('supercharge_userId', userId);
            
            document.getElementById('userIdPhase').classList.remove('active');
            document.getElementById('submissionPhase').classList.add('active');
            
            // Load today's superpower
            loadDailySuperpower();
        }

        // Auto-fill user ID if saved
        function checkSavedUser() {
            const savedUserId = localStorage.getItem('supercharge_userId');
            if (savedUserId) {
                document.getElementById('userId').value = savedUserId;
            }
        }
        
        // Load today's superpower challenge
        async function loadDailySuperpower() {
            try {
                let response, result;
                
                if (gameMode === 'room' && currentRoom) {
                    // For room mode, use the room's superpower
                    currentSuperpower = currentRoom.superpower;
                    currentSuperpower.id = currentRoomId; // Use room ID as superpower ID
                    document.getElementById('superpowerTitle').textContent = currentSuperpower.title;
                    document.getElementById('superpowerDescription').textContent = currentSuperpower.description;
                    return;
                } else if (gameMode === 'global') {
                    // For global mode, get today's superpower
                    response = await fetch(`${API_BASE_URL}/superpower`);
                    result = await response.json();
                    
                    if (result.success) {
                        currentSuperpower = result.superpower;
                        document.getElementById('superpowerTitle').textContent = result.superpower.title;
                        document.getElementById('superpowerDescription').textContent = result.superpower.description;
                        return;
                    }
                }
                
                // Fallback superpower for demo
                currentSuperpower = {
                    id: 'demo-1',
                    title: 'Perfect Memory',
                    description: 'You have the ability to remember everything with perfect clarity and recall any information instantly. How would you use this power to solve everyday problems and create value in creative ways?'
                };
                document.getElementById('superpowerTitle').textContent = currentSuperpower.title;
                document.getElementById('superpowerDescription').textContent = currentSuperpower.description;
                
            } catch (error) {
                console.error('Error loading superpower:', error);
                // Use fallback
                currentSuperpower = {
                    id: 'demo-1',
                    title: 'Perfect Memory',
                    description: 'You have the ability to remember everything with perfect clarity and recall any information instantly. How would you use this power to solve everyday problems and create value in creative ways?'
                };
                document.getElementById('superpowerTitle').textContent = currentSuperpower.title;
                document.getElementById('superpowerDescription').textContent = currentSuperpower.description;
            }
        }
        
        // Setup word counters for idea inputs
        function setupWordCounters() {
            for (let i = 1; i <= 4; i++) {
                const textarea = document.getElementById(`idea${i}`);
                const counter = document.getElementById(`count${i}`);
                
                textarea.addEventListener('input', () => {
                    const words = textarea.value.trim().split(/\s+/).filter(word => word.length > 0);
                    const wordCount = words.length;
                    
                    counter.textContent = `${wordCount}/100 words`;
                    
                    if (wordCount > 100) {
                        counter.classList.add('error');
                        counter.classList.remove('warning');
                    } else if (wordCount > 80) {
                        counter.classList.add('warning');
                        counter.classList.remove('error');
                    } else {
                        counter.classList.remove('warning', 'error');
                    }
                });
            }
        }
        
        // Setup deadline timer
        function setupDeadlineTimer() {
            function updateDeadline() {
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0); // Midnight tomorrow
                
                const timeLeft = tomorrow - now;
                
                if (timeLeft <= 0) {
                    document.getElementById('timeRemaining').textContent = 'Deadline passed';
                    return;
                }
                
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                document.getElementById('timeRemaining').textContent = 
                    `${hours}h ${minutes}m ${seconds}s`;
            }
            
            updateDeadline();
            deadlineTimer = setInterval(updateDeadline, 1000);
        }
        
        // Show status message
        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = isError ? 'status-message status-error' : 'status-message status-success';
            statusEl.classList.remove('hidden');
            
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 5000);
        }
        
        // Submit ideas
        document.getElementById('ideaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const ideas = [];
            let hasErrors = false;
            
            // Validate all ideas
            for (let i = 1; i <= 4; i++) {
                const textarea = document.getElementById(`idea${i}`);
                const text = textarea.value.trim();
                
                if (!text) {
                    showStatus(`Please fill in Idea #${i}`, true);
                    return;
                }
                
                const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
                if (wordCount > 100) {
                    showStatus(`Idea #${i} exceeds 100 words (${wordCount} words)`, true);
                    return;
                }
                
                ideas.push(text);
            }
            
            // Set loading state
            const submitBtn = document.getElementById('submitIdeasBtn');
            const submitText = document.getElementById('submitText');
            const submitLoader = document.getElementById('submitLoader');
            
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoader.classList.remove('hidden');
            
            try {
                const requestBody = {
                    userId: currentUser,
                    superpowerId: currentSuperpower.id,
                    ideas: ideas
                };
                
                // Add roomId for room-based games
                if (gameMode === 'room' && currentRoomId) {
                    requestBody.roomId = currentRoomId;
                }
                
                const response = await fetch(`${API_BASE_URL}/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('Ideas submitted successfully!');
                    
                    // Move to rating phase after 2 seconds
                    setTimeout(() => {
                        document.getElementById('submissionPhase').classList.remove('active');
                        document.getElementById('ratingPhase').classList.add('active');
                        startRatingPhase();
                    }, 2000);
                } else {
                    showStatus(`Error: ${result.error}`, true);
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, true);
            } finally {
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitLoader.classList.add('hidden');
            }
        });
        
        // Start rating phase
        function startRatingPhase() {
            let timeLeft = 15 * 60; // 15 minutes
            
            function updateRatingTimer() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('ratingTimeRemaining').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(ratingTimer);
                    finishRating();
                    return;
                }
                
                timeLeft--;
            }
            
            updateRatingTimer();
            ratingTimer = setInterval(updateRatingTimer, 1000);
            
            // Load rating pairs
            loadRatingPairs();
        }
        
        // Load rating pairs from API
        async function loadRatingPairs() {
            try {
                let url = `${API_BASE_URL}/rating/pairs?userId=${currentUser}`;
                
                // Add roomId for room-based games
                if (gameMode === 'room' && currentRoomId) {
                    url += `&roomId=${currentRoomId}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (response.ok && result.pairs && result.pairs.length > 0) {
                    displayRatingPair(result.pairs[0]);
                } else {
                    // No more pairs to rate
                    document.getElementById('ratingContent').innerHTML = `
                        <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <h3>üéâ Rating Complete!</h3>
                            <p>You've rated all available pairs. Great job!</p>
                            <button class="btn" onclick="finishRating()" style="margin-top: 15px; width: auto; padding: 15px 30px;">
                                View Results
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading rating pairs:', error);
                document.getElementById('ratingContent').innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                        <h3>Unable to load rating pairs</h3>
                        <p>There might be no other submissions to rate yet.</p>
                        <button class="btn" onclick="finishRating()" style="margin-top: 15px; width: auto; padding: 15px 30px;">
                            Skip to Results
                        </button>
                    </div>
                `;
            }
        }
        
        // Display a rating pair for user to rate
        function displayRatingPair(pair) {
            const content = `
                <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="text-align: center; margin-bottom: 25px; color: #667eea;">Rate Similarity (1-5)</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                            <h4 style="margin: 0 0 15px 0; color: #555;">Ideas from ${pair.submission1.userId}</h4>
                            ${pair.submission1.ideas.map((idea, i) => `
                                <p style="margin: 8px 0; padding: 10px; background: white; border-radius: 8px;">
                                    <strong>${i+1}.</strong> ${idea}
                                </p>
                            `).join('')}
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #764ba2;">
                            <h4 style="margin: 0 0 15px 0; color: #555;">Ideas from ${pair.submission2.userId}</h4>
                            ${pair.submission2.ideas.map((idea, i) => `
                                <p style="margin: 8px 0; padding: 10px; background: white; border-radius: 8px;">
                                    <strong>${i+1}.</strong> ${idea}
                                </p>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <p style="margin: 15px 0; font-weight: 600;">How similar are these two sets of ideas?</p>
                        <div style="display: flex; justify-content: center; gap: 10px; margin: 20px 0;">
                            ${[1,2,3,4,5].map(rating => `
                                <button class="rating-btn" data-rating="${rating}" onclick="submitRating('${pair.submission1.submissionId}', '${pair.submission2.submissionId}', ${rating})"
                                        style="padding: 15px 20px; border: 2px solid #ddd; background: white; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                                    ${rating}
                                </button>
                            `).join('')}
                        </div>
                        <p style="font-size: 14px; color: #666; margin: 10px 0;">
                            1 = Very Different &nbsp;‚Ä¢&nbsp; 3 = Somewhat Similar &nbsp;‚Ä¢&nbsp; 5 = Very Similar
                        </p>
                    </div>
                </div>
            `;
            
            document.getElementById('ratingContent').innerHTML = content;
            
            // Style rating buttons on hover
            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.addEventListener('mouseenter', function() {
                    this.style.borderColor = '#667eea';
                    this.style.backgroundColor = '#f0f2ff';
                });
                btn.addEventListener('mouseleave', function() {
                    this.style.borderColor = '#ddd';
                    this.style.backgroundColor = 'white';
                });
            });
        }
        
        // Submit a rating and load next pair
        async function submitRating(submissionId1, submissionId2, rating) {
            try {
                const requestBody = {
                    userId: currentUser,
                    submissionId1: submissionId1,
                    submissionId2: submissionId2,
                    rating: rating
                };
                
                // Add roomId for room-based games
                if (gameMode === 'room' && currentRoomId) {
                    requestBody.roomId = currentRoomId;
                }
                
                const response = await fetch(`${API_BASE_URL}/rating`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Show accuracy feedback if available
                    if (result.feedback) {
                        showRatingFeedback(result.feedback);
                    }
                    
                    // Load next pair
                    setTimeout(() => {
                        loadRatingPairs();
                    }, 1500);
                } else {
                    alert(`Error submitting rating: ${result.error}`);
                }
            } catch (error) {
                console.error('Error submitting rating:', error);
                alert('Network error submitting rating');
            }
        }
        
        // Show rating accuracy feedback
        function showRatingFeedback(feedback) {
            const { userRating, expectedRating, embeddingSimilarity, accuracyScore } = feedback;
            
            // Get similarity description
            let similarityDesc = "moderate";
            if (embeddingSimilarity > 0.7) similarityDesc = "very high";
            else if (embeddingSimilarity > 0.5) similarityDesc = "high";
            else if (embeddingSimilarity > 0.3) similarityDesc = "moderate";
            else if (embeddingSimilarity > 0.1) similarityDesc = "low";
            else similarityDesc = "very low";
            
            // Get accuracy description and color
            let accuracyDesc = "Good job!";
            let accuracyColor = "#4caf50";
            if (accuracyScore >= 90) { accuracyDesc = "Excellent!"; accuracyColor = "#2e7d32"; }
            else if (accuracyScore >= 75) { accuracyDesc = "Great!"; accuracyColor = "#388e3c"; }
            else if (accuracyScore >= 50) { accuracyDesc = "Good!"; accuracyColor = "#689f38"; }
            else if (accuracyScore >= 25) { accuracyDesc = "Keep trying!"; accuracyColor = "#f57c00"; }
            else { accuracyDesc = "Try again!"; accuracyColor = "#d32f2f"; }
            
            // Show feedback popup
            const feedbackHtml = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                           background: white; padding: 25px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                           z-index: 1000; max-width: 400px; text-align: center; border: 3px solid ${accuracyColor};">
                    <h3 style="color: ${accuracyColor}; margin: 0 0 15px 0;">${accuracyDesc}</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <p style="margin: 5px 0;"><strong>Your Rating:</strong> ${userRating}/5</p>
                        <p style="margin: 5px 0;"><strong>AI Expected:</strong> ${expectedRating}/5</p>
                        <p style="margin: 5px 0; font-size: 14px; color: #666;">
                            The AI found ${similarityDesc} similarity (${(embeddingSimilarity * 100).toFixed(1)}%)
                        </p>
                    </div>
                    <div style="font-size: 24px; font-weight: bold; color: ${accuracyColor}; margin: 10px 0;">
                        ${accuracyScore}% Accuracy
                    </div>
                    <p style="font-size: 12px; color: #666; margin: 10px 0;">
                        Your accuracy score is based on how well your rating matches the AI's semantic analysis.
                    </p>
                </div>
            `;
            
            // Add to page
            const feedbackDiv = document.createElement('div');
            feedbackDiv.innerHTML = feedbackHtml;
            feedbackDiv.id = 'ratingFeedback';
            document.body.appendChild(feedbackDiv);
            
            // Remove after 3 seconds
            setTimeout(() => {
                const el = document.getElementById('ratingFeedback');
                if (el) el.remove();
            }, 3000);
        }
        
        // Finish rating and show results
        function finishRating() {
            if (ratingTimer) {
                clearInterval(ratingTimer);
            }
            
            document.getElementById('ratingPhase').classList.remove('active');
            document.getElementById('resultsPhase').classList.add('active');
            
            // Mock results
            const percentiles = [20, 35, 50, 65, 80];
            const randomPercentile = percentiles[Math.floor(Math.random() * percentiles.length)];
            document.getElementById('resultsMessage').textContent = 
                `Great job! You scored in the top ${randomPercentile}% of participants!`;
        }
        
        // Initialize on page load
        init();
    </script>
</body>
</html>